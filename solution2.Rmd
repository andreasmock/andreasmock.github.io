---
title: "Angewandte Datenanalyse mit `R`"
subtitle: "Tag 2 - Datentransformation und -visualierung "
output:
  html_document:
    toc: true
    toc_float: true
---

```{r, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survival)
library(survminer)
library(tidyverse)
load(url("http://andreasmock.github.io/data/hnscc.RData"))
```

<br>

### Lösungen Übung 3

Eigenschaften von Tibbles über klassische Dataframes hinaus 

- Trunkierte, zusammengefasste Ausgabe in der Konsole. No need for head().
- Giben Vektortyp einer jeden Spalte an, z.B. Charakter `<chr>`.
- Zeigen die Dimensionen eines Dataframes vorneweg an, z.B. A tibble: 279 x 11

<br>


### Lösungen Übung 4

a) Junge Patienten (< 50 Jahre), Nichtraucher, Zeilen sortiert nach Alter.

```{r}
hnscc %>%
    filter(age<50, tabacco_group=="Lifelong Non-smoker") %>%
    arrange(age)
```

b) Dataframe mit Spalten “age” und “grade”. Ändert die Spaltennamen ins Deutsche um.

```{r}
hnscc %>%
    select(age,grade) %>%
    rename(Alter=age,Grading=grade)
```

c) Fügt dem hnscc Dataframe eine neue Spalte mit Namen “is_young” hinzu, die mit TRUE und FALSE kodiert, ob jemand < 50 Jahre ist.

```{r}
hnscc <- hnscc %>%
    mutate(is_young=(age<50))

table(hnscc$is_young)
```


d) Berechnet das mediane Gesamtüberleben nach Grading. Ist das Resultat biologisch plausibel?

```{r}
hnscc %>%
    group_by(grade) %>%
    summarise(mean_OS = mean(days_to_death, na.rm=TRUE))
```

<br>

### Lösungen Übung 5

a) In der heutigen Präsentation haben wir neben x-Achse und y-Achse weitere Aesthetics (shape, color, size), sowie das Facetting kennen gelernt. Überlegt euch eine sinnvolle Visualisierung (am besten Dotplot), die insgesamt 5 Dimensionen der Daten abbilden.

```{r}
ggplot(hnscc, aes(x=age, y=days_to_death, color=neoplasm_site, shape=grade)) + 
    geom_point() +
    facet_wrap(~alcohol)
```

b) Versucht die Transformationen und Settings des folgenden Barplots nachzuvollziehen. Wie wird hier die Transformation mit dem Plotten verzahnt? Was macht z.B. `coord_flip`?

```{r, eval=FALSE}
hnscc  %>%
    group_by(neoplasm_site) %>%
    summarize(mean_age=mean(age)) %>%
    ggplot(aes(x=reorder(neoplasm_site,mean_age),y=mean_age)) +
    geom_bar(stat="identity") +
    coord_flip() +
    xlab("anatomical site") +
    ylab("mean age")
```

In diesem Codebespiel wurde die Transformation mit der Pipefunktion `%>%` mit dem Plotten verzahnt. Kontraintuitiv ist, dass die Transformation mit einer Pipefunktion und das Plotten mit einem `+` verbunden ist. `coord_flip()` dreht die Achsen um, was die Kategorien besser leserlich macht. Zudem wurde die Reihenfolge der anatomischen Region mit `reorder` nach mittlerem Alter geordnet. 


c) "Googled" danach, wie man dem folgenden Plot eine Regressionsgrade hinzufügen kann:

```{r}
ggplot(hnscc, aes(x=age, y=days_to_death)) +
    geom_point() +
    geom_smooth(method="lm")
```

<br>

### Lösungen Übung 6

Sucht euch andere Faktoren aus den `hnscc` Metadaten und untersucht deren Einfluss auf das Gesamtüberleben.

```{r}
# Overall survival (OS) ist bereits richtig formatiert (als integer in Tagen)
# Censor muss noch richtig formatiert werden (0 = zensiert, 1 = gestorben)
hnscc_survival <- hnscc %>%
    dplyr::rename(OS=days_to_death) %>%
    mutate(Censor = as.factor(vital_status))

levels(hnscc_survival$Censor) <- c(1,0)    

hnscc_survival$Censor = as.numeric(hnscc_survival$Censor)
```


```{r}
colnames(hnscc)[-c(1,4,11)]
```

```{r}
#Template
fit <- survfit(Surv(OS, Censor)~age<50, data=hnscc_survival)

ggsurvplot(fit, hnscc_survival, risk.table = FALSE, 
           pval=TRUE, tables.height=0.25,
           xlab="Time (months)")
```
